(()=>{"use strict";var s={d:(e,i)=>{for(var t in i)s.o(i,t)&&!s.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:i[t]})},o:(e,i)=>Object.prototype.hasOwnProperty.call(e,i)},e={};s.d(e,{default:()=>function(){return new d}});class i{_message;_code;constructor(e,i){this._message=e,this._code=i}get message(){return this._message}get code(){return this._code}}class t extends i{constructor(e){super(`First-id cookie "${e}" not found`,"FirstIdCookieNotFound")}}class r extends i{constructor(e){super(`First-id cookie "${e}" contains an empty value`,"FirstIdEmptyValue")}}class o extends i{constructor(){super("The current user has opted out of tracking","FirstIdUserDoNotTrack")}}class a extends i{constructor(){super('The config "emailGetterCallback" must be a function',"FirstIdEmailGetterCallbackIsNotFunction")}}const n={API_URL:"https://api.first-id.fr",API_V6_URL:"https://api-v6.prod.first-id.fr",SDK_VERSION:"1.4.1",COOKIE_NAME:"firstid",FLEX:"false"};class d{_version;_emailHashed;intervalReferenceRequestFirstIdFromParent;logger;constructor(){this._version=n.SDK_VERSION,this.intervalReferenceRequestFirstIdFromParent=null,this._firstId=null,this._emailHashed=null,this._config={callbacks:[],cookieName:n.COOKIE_NAME,cookieNameTTLInMinute:259200,version:this._version,debug:!1,isIframe:!1,intervalRequestFirstIdFromParentMs:100,callbacksWhenIframeReceiveFirstId:[],iframeAppendFirstIdToLinkCssSelector:[],emailCookieName:"fid_email_hashed",emailHashed:null,emailGetterCallback:null,firstIdFlexFeature:"true"===n.FLEX,syncIpUaCookieName:"fidflexlastsync",syncFidEmailCookieName:"fidflexemaillastsync",refreshCookieName:"firstid_refresh",firstIdApiBaseUrl:n.API_URL,firstIdApiV6BaseUrl:n.API_V6_URL,...window.firstId||{}},this.logger={log:()=>{this.config.debug||window?.firstId?.debug},debug:()=>{this.config.debug||window?.firstId?.debug},error:()=>{this.config.debug||window?.firstId?.debug},warn:()=>{this.config.debug||window?.firstId?.debug}},this.logger.debug("First-id SDK initialized. Current version is : "+this._version);try{var e=this.getId();this._setOutbrainPPID(e),this._addFirstIdToGoogleSecureSignal(e)}catch(e){this.logger.error("Error on set outbrain PPID",e)}}_firstId;get firstId(){return this.getFirstId()}set firstId(e){this._firstId=e,document&&window&&(window.__FIRSTID__=e,document.__FIRSTID__=e,0),this._setFirstIdCookie(e);try{this._setOutbrainPPID(e)}catch(e){this.logger.error("Error on set outbrain PPID",e)}try{this._addFirstIdToGoogleSecureSignal(e)}catch(e){this.logger.error("Error on set google secure signal",e)}}_config;get config(){return this.getConfig()}set config(e){if(518400<e.cookieNameTTLInMinute)throw new Error("cookieNameTTLInMinute must be less than 12 months");this._config=e}get version(){return this._version}getFirstId(){if(this._config.isIframe&&this._firstId)return this._firstId;var e=this.__getCookieValueFromCookieName(this._config.cookieName);if(null===e&&!this.config.firstIdFlexFeature)throw new t(this._config.cookieName);if(""===e)throw new r(this._config.cookieName);if("NO_TRACKING"===e)throw new o;return e}getEmailHashed(){if(this._emailHashed??this._config.emailHashed)return this._emailHashed??this._config.emailHashed;let e=null;if(this._config.emailCookieName&&this.__getCookieValueFromCookieName(this._config.emailCookieName))e=this.__getCookieValueFromCookieName(this._config.emailCookieName);else if(this._config.emailHashed)e=this._config.emailHashed;else if(this._config.getEmailMethod)try{e=this._config.getEmailMethod()}catch(e){this.logger.error("[FIRSTID] Error on getEmailMethod",e)}return e}getFirstIdEidsObject(){return[{source:"first-id.fr",uids:[{atype:1,ext:{stype:"ppuid"},id:this.getId()}]}]}getCookieName(){return this._config.cookieName}setCookieName(e){this._config.cookieName=e}askFirstIdToParentIframe(){this._config.intervalReferenceRequestFirstIdFromParent=setInterval(()=>{this.logger.debug(`Request FirstID from parent each ${this._config.intervalRequestFirstIdFromParentMs} ms...`),window.top.postMessage("requestFirstID","*")},this._config.intervalRequestFirstIdFromParentMs),window.addEventListener("message",e=>{this.logger.log("message from parent",e),this.logger.debug("[FIRSTID IFRAME] message from parent",e),e.data.firstid&&(clearInterval(this._config.intervalReferenceRequestFirstIdFromParent),this.logger.debug("[FIRSTID IFRAME] iFrame has been receive successfully firstID "+e.data.firstid,e),this._firstId=e.data.firstid,e.data.firstid,e.source.postMessage("firstidACK","*"),this.iframeAppendFirstIdToLink(),this._config.callbacksWhenIframeReceiveFirstId.forEach((i,t)=>{this.logger.debug("[FIRSTID IFRAME] Invoke callback start #"+t,i);try{i(this._firstId),this.logger.debug("[FIRSTID IFRAME] Invoke callback done #"+t,i)}catch(e){this.logger.error(`[FIRSTID IFRAME] Callback #${t} throw an error`,i)}}))},!0)}async setEmailHashed(e){var i;this._firstId?((i=await this._checkMatchCookieWIthEMail(e))||this.logger.debug("[FIRSTID] Error on check match cookie with email"),i&&!i?.match&&(this._setFirstIdCookie(i?.firstId),this._createRefreshCookie())):((i=await this._checkEmailExist(e))?.exist?this._setFirstIdCookie(i.firstId):(i=await this._createFirstIdByEmail(e),this._setFirstIdCookie(i.firstId)),this._createRefreshCookie())}async init(){if(null!==this._config.emailGetterCallback&&"function"!=typeof this._config.emailGetterCallback)throw new a;try{this._firstId=this.getId(),this._emailHashed=this.getEmailHashed()}catch(e){this._firstId=null,this._emailHashed=null}this._config.isIframe?this.askFirstIdToParentIframe():(this._addListerFromIframeMessage(),this._firstId?(this._hashAlreadyUpdateIpUa()||await this._updateIpUa(),this._emailHashed&&!this._hashAlreadyCheckFirstIdEmailAssociation()&&await this.setEmailHashed(this._emailHashed)):!this.firstId&&this._config.firstIdFlexFeature&&this._getFirstIdByIPUA().then(e=>{e&&(this.firstId=e.firstId)}))}iframeAppendFirstIdToLink(){this.logger.debug("[FIRSTID IFRAME] Try to append firstID to link with the css selector",this._config.iframeAppendFirstIdToLinkCssSelector),this._config.iframeAppendFirstIdToLinkCssSelector.forEach(e=>{var i=document.querySelectorAll(e);this.logger.debug(`[FIRSTID IFRAME] Found ${i.length} links for cssSelector `+e),0!==i.length&&i.forEach(e=>{e.href&&!e.href.includes("firstid")?-1===e.href.indexOf("?")?e.href+="?firstid="+this._firstId:e.href+="&firstid="+this._firstId:e.src&&!e.src.includes("firstid")&&(-1===e.src.indexOf("?")?e.src+="?firstid="+this._firstId:e.src+="&firstid="+this._firstId)})})}getId(){if(this.config.isIframe&&this.firstId)return this.firstId;var e=this.__getCookieValueFromCookieName(this.config.cookieName);if(null===e)throw new t(this.config.cookieName);if(""===e)throw new r(this.config.cookieName);if("NO_TRACKING"===e)throw new o;return e}getVersion(){return this.version}getConfig(){return this._config}__getCookieValueFromCookieName(i){var t=document.cookie.split(";");for(let e=0;e<t.length;e++){var s=t[e].split("=");if(i===s[0].trim())return decodeURIComponent(s[1])}return null}_addListerFromIframeMessage(){window.addEventListener("message",e=>{this.logger.debug("[FIRSTID] message from iframe",e),"firstidACK"===e.data&&this.logger.log("[FIRSTID] iFrame has been receive successfully firstID",e),"requestFirstID"===e.data&&(this.logger.log("[FIRSTID] iFrame request firstID",e),e.source.postMessage({firstid:this.getId()},"*"))},!0)}_hashAlreadyUpdateIpUa(){return!!this.__getCookieValueFromCookieName(this._config.syncIpUaCookieName)}_hashAlreadyCheckFirstIdEmailAssociation(){return!!this.__getCookieValueFromCookieName(this._config.syncFidEmailCookieName)}async _updateIpUa(){if(this._firstId){var e=[navigator?.userAgent??"",navigator?.language??"",screen?.width??0,screen?.height??0,navigator?.deviceMemory??0,navigator?.hardwareConcurrency??0].join("::");let i=await fetch(`${this._config.firstIdApiBaseUrl}/firstId?firstId=${this._firstId}&int=`+(this.config.firstIdFlexFeature?1:0),{method:"PUT",body:JSON.stringify({bd:e})});fetch(this._config.firstIdApiV6BaseUrl+"/firstId?firstId="+this._firstId,{method:"PUT",body:JSON.stringify({bd:e})}).then(e=>{this.logger.debug("[FIRSTID][V6] Update FirstID print done")}).catch(e=>{this.logger.error("[FIRSTID][V6] Error on update FirstID print",i.status,i.statusText)}),i.ok?(this._setCookie(this._config.syncIpUaCookieName,"1",360),this.logger.debug("[FIRSTID] Update FirstID print done")):this.logger.error("[FIRSTID] Error on update FirstID print",i.status,i.statusText)}else this.logger.debug("[FIRSTID] Can't update ip and ua because firstId is null")}_checkMatchCookieWIthEMail=async e=>{if(this._firstId)return(e=await fetch(`${this._config.firstIdApiBaseUrl}/emailAssoc?firstId=${this._firstId}&email=${e}&c=`+btoa(JSON.stringify({u:window.location.href,int:this.config.firstIdFlexFeature?"1":"0"})),{})).ok?(this.logger.debug("[FIRSTID] Check match cookie with email done"),e.json()):void this.logger.error("[FIRSTID] Error on check match cookie with email",e.status,e.statusText);this.logger.debug("[FIRSTID] Can't check match cookie with email because firstId is null")};_setFirstIdCookie(e){this._setCookie(this._config.cookieName,e,this._config.cookieNameTTLInMinute)}_createRefreshCookie(){this._setCookie(this._config.refreshCookieName,"1",this._config.cookieNameTTLInMinute)}async _checkEmailExist(e){e=await fetch(this._config.firstIdApiBaseUrl+`/emailExist?email=${e}&c=`+btoa(JSON.stringify({u:window.location.href,int:this.config.firstIdFlexFeature?"1":"0"})),{});if(e.ok)return this.logger.debug("[FIRSTID] Check email exist done"),e.json();this.logger.error("[FIRSTID] Error on check email exist",e.status,e.statusText)}async _createFirstIdByEmail(e){e=await fetch(this._config.firstIdApiBaseUrl+"/createFidViaEmail",{method:"POST",body:JSON.stringify({email:e,u:window.location.href,int:this.config.firstIdFlexFeature?"1":"0"})});if(e.ok)return this.logger.debug("[FIRSTID] Create first-id by email done"),e.json();this.logger.error("[FIRSTID] Error on create first-id by email",e.status,e.statusText)}async _getFirstIdByIPUA(){var e=await fetch(this._config.firstIdApiBaseUrl+"/firstId?int="+(this.config.firstIdFlexFeature?1:0),{});if(e.ok)return this.logger.debug("[FIRSTID] Get first-id by print done"),e.json();this.logger.error("[FIRSTID] Error on get first-id by print",e.status,e.statusText)}_setOutbrainPPID(e){window.OB_ppids=window.OB_ppids||[],window.OB_ppids.push({name:"first-id.fr",value:e})}_setCookie(e,i,t){var s=new Date,t=(s.setTime(s.getTime()+60*t*1e3),"expires="+s.toUTCString());let r,o=(r=this.config.cookieDomain?"."===this.config.cookieDomain.charAt(0)?this.config.cookieDomain:"."+this.config.cookieDomain:window.location.hostname.split(".").slice(-2).join("."),"");"https:"===window.location.protocol&&(o=";Secure"),document.cookie=e+"="+i+"; "+t+"; path=/; domain="+r+o}_addFirstIdToGoogleSecureSignal(i){window.googletag=window.googletag??{},window.googletag.secureSignalProviders=window.googletag.secureSignalProviders??[],window.googletag.secureSignalProviders.push({id:"first-id.fr",collectorFunction:()=>new Promise(e=>{e(i)})})}}window.FirstIdSdk=e.default})();